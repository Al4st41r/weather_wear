<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Weather Wear</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #fff;
    color: #333;
    margin: 0;
    padding: 0;
    text-align: center;
  }
  header {
    padding: 1rem;
    font-size: 1.5rem;
    font-weight: bold;
    border-bottom: 1px solid #ccc;
  }
  .controls {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem;
    max-width: 400px;
    margin: auto;
  }
  .controls input, .controls button {
    padding: 0.6rem;
    font-size: 1rem;
  }
  .recommendation {
    padding: 1rem;
    max-width: 400px;
    margin: 1rem auto;
    border: 1px solid #ddd;
    border-radius: 8px;
  }
  .recommendation h2 {
    margin-top: 0;
  }
  .clothing-item {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin: 0.3rem 0;
  }
  svg {
    width: 24px;
    height: 24px;
    stroke: #333;
    fill: none;
    stroke-width: 2;
  }
</style>
</head>
<body>
  <header>Weather Wear</header>

  <div class="controls">
    <input type="text" id="cityInput" placeholder="Enter city (default London)">
    <button onclick="fetchWeatherByCity()">Check Weather</button>
    <button onclick="fetchWeatherByLocation()">Use My Location</button>
  </div>

  <div id="recommendation" class="recommendation">
    <h2>Loading weather...</h2>
    <p>Please wait</p>
  </div>

<script>
const workerBase = "https://weather-proxy.alastairogle.workers.dev";

document.addEventListener("DOMContentLoaded", () => {
  fetchWeatherByCity("London");
});

async function fetchWeatherByCity(city = null) {
  if (!city) {
    city = document.getElementById("cityInput").value.trim() || "London";
  }
  try {
    const [current, forecast] = await Promise.all([
      fetch(`${workerBase}/weather?q=${encodeURIComponent(city)}&units=metric`).then(r => r.json()),
      fetch(`${workerBase}/forecast?q=${encodeURIComponent(city)}&units=metric`).then(r => r.json())
    ]);
    processWeatherData(current, forecast);
  } catch (err) {
    showError("Could not fetch weather data.");
  }
}

function fetchWeatherByLocation() {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      try {
        const [current, forecast] = await Promise.all([
          fetch(`${workerBase}/weather?lat=${lat}&lon=${lon}&units=metric`).then(r => r.json()),
          fetch(`${workerBase}/forecast?lat=${lat}&lon=${lon}&units=metric`).then(r => r.json())
        ]);
        processWeatherData(current, forecast);
      } catch (err) {
        showError("Could not fetch weather data.");
      }
    }, () => {
      showError("Location permission denied. Using London instead.");
      fetchWeatherByCity("London");
    });
  } else {
    showError("Geolocation not supported. Using London instead.");
    fetchWeatherByCity("London");
  }
}

function processWeatherData(current, forecast) {
  if (!current.main || !forecast.list) {
    showError("Invalid weather data received.");
    return;
  }

  const temp = current.main.temp;
  const humidity = current.main.humidity;
  const wind = current.wind.speed;
  const weatherNow = current.weather[0].main.toLowerCase();

  const next3h = forecast.list[0];
  const forecastWeather = next3h.weather[0].main.toLowerCase();
  const rainSnowComing = ["rain", "snow"].some(w => forecastWeather.includes(w));

  const wet = ["rain", "snow"].some(w => weatherNow.includes(w)) || rainSnowComing;
  const windy = wind > 20;
  const cold = temp < 10;
  const veryCold = temp < 5;
  const hot = temp > 22;

  const layers = [];
  if (veryCold) {
    layers.push({text: "Heavy coat", icon: coatIcon()});
    layers.push({text: "Scarf & gloves", icon: scarfIcon()});
  } else if (cold) {
    layers.push({text: "Jacket", icon: jacketIcon()});
  } else if (hot) {
    layers.push({text: "T-shirt", icon: tshirtIcon()});
  } else {
    layers.push({text: "Light jumper", icon: jumperIcon()});
  }

  if (wet) {
    layers.push({text: "Waterproof layer", icon: raincoatIcon()});
  }
  if (windy) {
    layers.push({text: "Windbreaker", icon: windIcon()});
  }
  if (humidity > 80 && !wet && !cold) {
    layers.push({text: "Breathable fabric", icon: tshirtIcon()});
  }

  displayRecommendation(current.name, temp, weatherNow, layers);
}

function displayRecommendation(location, temp, weather, layers) {
  const recDiv = document.getElementById("recommendation");
  recDiv.innerHTML = `<h2>${location}</h2>
    <p>${Math.round(temp)}Â°C, ${weather}</p>
    <h3>Recommended layers:</h3>
    ${layers.map(l => `<div class="clothing-item">${l.icon}<span>${l.text}</span></div>`).join("")}`;
}

function showError(msg) {
  document.getElementById("recommendation").innerHTML = `<h2>Error</h2><p>${msg}</p>`;
}

// Icons
function coatIcon(){return `<svg viewBox="0 0 24 24"><path d="M6 2v20M18 2v20M6 2h12M6 22h12"/></svg>`;}
function scarfIcon(){return `<svg viewBox="0 0 24 24"><path d="M4 4h16M4 8h16M10 8v12M14 8v12"/></svg>`;}
function jacketIcon(){return `<svg viewBox="0 0 24 24"><path d="M8 2h8v20H8zM8 6h8"/></svg>`;}
function tshirtIcon(){return `<svg viewBox="0 0 24 24"><path d="M4 4l4-2h8l4 2v4H4zM6 8v14M18 8v14"/></svg>`;}
function jumperIcon(){return `<svg viewBox="0 0 24 24"><path d="M6 2h12v6H6zM6 8v14M18 8v14"/></svg>`;}
function raincoatIcon(){return `<svg viewBox="0 0 24 24"><path d="M12 2l6 6v14H6V8z"/></svg>`;}
function windIcon(){return `<svg viewBox="0 0 24 24"><path d="M2 8h14M2 12h10M2 16h18"/></svg>`;}
</script>
</body>
</html>
